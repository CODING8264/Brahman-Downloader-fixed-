name: Build Signed APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        run: npm install

      - name: Install Capacitor CLI
        run: npm install -g @capacitor/cli

      - name: Add Android platform
        run: npx cap add android
        timeout-minutes: 5

      - name: Copy web assets
        run: npx cap copy android

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ hashFiles('**/*.gradle*') }}
          restore-keys: gradle-

      - name: Decode Keystore from Secret
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/brahman.keystore
          echo "âœ… Keystore decoded"

      - name: Inject signing config into build.gradle
        run: |
          # Inject signingConfigs BEFORE buildTypes in app/build.gradle
          python3 << 'PYEOF'
          import re

          with open('android/app/build.gradle', 'r') as f:
              content = f.read()

          signing_block = """
              signingConfigs {
                  release {
                      storeFile file('brahman.keystore')
                      storePassword System.getenv('KEYSTORE_PASSWORD')
                      keyAlias System.getenv('KEY_ALIAS')
                      keyPassword System.getenv('KEY_PASSWORD')
                      v1SigningEnabled true
                      v2SigningEnabled true
                  }
              }
          """

          # Insert signingConfigs before buildTypes
          content = content.replace(
              'buildTypes {',
              signing_block + '\n    buildTypes {'
          )

          # Update release buildType to use signingConfig
          content = content.replace(
              'release {',
              'release {\n            signingConfig signingConfigs.release',
              1
          )

          with open('android/app/build.gradle', 'w') as f:
              f.write(content)

          print("âœ… Signing config injected successfully")
          PYEOF

      - name: Make gradlew executable
        run: chmod +x android/gradlew

      - name: Build Signed Release APK
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          cd android
          ./gradlew assembleRelease --no-daemon
        timeout-minutes: 25

      - name: Locate and verify APK
        run: |
          echo "ðŸ” Finding APK..."
          find android -name "*.apk" -type f -ls

          APK_PATH="android/app/build/outputs/apk/release/app-release.apk"

          if [ -f "$APK_PATH" ]; then
            cp "$APK_PATH" BrahmanDownloader.apk
            echo "âœ… Found signed APK"
          else
            echo "âŒ Signed APK not found!"
            exit 1
          fi

          ls -lh BrahmanDownloader.apk

      - name: Verify APK signature
        run: |
          BUILD_TOOLS=$(ls $ANDROID_HOME/build-tools | sort -V | tail -1)
          echo "Using build-tools: $BUILD_TOOLS"
          $ANDROID_HOME/build-tools/$BUILD_TOOLS/apksigner verify \
            --verbose \
            --print-certs \
            BrahmanDownloader.apk
          echo "âœ… APK signature verified!"

      - name: Upload Signed APK
        uses: actions/upload-artifact@v4
        with:
          name: BrahmanDownloader-APK
          path: BrahmanDownloader.apk
          retention-days: 30
