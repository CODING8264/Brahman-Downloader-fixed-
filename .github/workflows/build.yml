name: Build Signed APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 3Ô∏è‚É£ Setup Java
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 4Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm install

      # 5Ô∏è‚É£ Install Capacitor CLI
      - name: Install Capacitor CLI
        run: npm install -g @capacitor/cli

      # 6Ô∏è‚É£ Add Android platform (if not exists)
      - name: Add Android platform
        run: npx cap add android || echo "Platform already exists"
        timeout-minutes: 5

      # 7Ô∏è‚É£ Copy web assets
      - name: Copy web assets
        run: npx cap copy android

      # 8Ô∏è‚É£ Cache Gradle
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ hashFiles('**/*.gradle*') }}
          restore-keys: gradle-

      # 9Ô∏è‚É£ Decode keystore from secret
      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | tr -d '\n' | base64 --decode > android/app/brahman.keystore
          echo "‚úî Keystore decoded"

      # üîü Make gradlew executable
      - name: Make gradlew executable
        run: chmod +x android/gradlew

      # 1Ô∏è‚É£1Ô∏è‚É£ Build Release APK
      - name: Build Release APK
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          cd android
          ./gradlew assembleRelease --no-daemon
        timeout-minutes: 25

      # 1Ô∏è‚É£2Ô∏è‚É£ Sign APK with apksigner
      - name: Sign APK (v2/v3)
        run: |
          cd android
          BUILD_TOOLS=$(ls $ANDROID_HOME/build-tools | sort -V | tail -1)
          echo "Using build-tools: $BUILD_TOOLS"
          $ANDROID_HOME/build-tools/$BUILD_TOOLS/apksigner sign \
            --ks app/brahman.keystore \
            --ks-pass pass:${{ secrets.KEYSTORE_PASSWORD }} \
            --key-pass pass:${{ secrets.KEY_PASSWORD }} \
            app/build/outputs/apk/release/app-release-unsigned.apk

      # 1Ô∏è‚É£3Ô∏è‚É£ Zipalign APK
      - name: Align APK
        run: |
          cd android
          BUILD_TOOLS=$(ls $ANDROID_HOME/build-tools | sort -V | tail -1)
          $ANDROID_HOME/build-tools/$BUILD_TOOLS/zipalign -v 4 \
            app/build/outputs/apk/release/app-release-unsigned.apk \
            app/build/outputs/apk/release/BrahmanDownloader.apk

      # 1Ô∏è‚É£4Ô∏è‚É£ Verify APK signature
      - name: Verify APK signature
        run: |
          cd android
          BUILD_TOOLS=$(ls $ANDROID_HOME/build-tools | sort -V | tail -1)
          $ANDROID_HOME/build-tools/$BUILD_TOOLS/apksigner verify \
            --verbose \
            --print-certs \
            app/build/outputs/apk/release/BrahmanDownloader.apk
          echo "‚úî APK signature verified"

      # 1Ô∏è‚É£5Ô∏è‚É£ Upload artifact
      - name: Upload Signed APK
        uses: actions/upload-artifact@v4
        with:
          name: BrahmanDownloader-APK
          path: android/app/build/outputs/apk/release/BrahmanDownloader.apk
          retention-days: 30
